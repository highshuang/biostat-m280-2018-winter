---
title: "m280 homework3"
author: "Shuang Gao"
date: "2018/2/28"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```


```{r}
if (!"DBI" %in% rownames(installed.packages()))  
      install.packages("DBI", repos = "http://cran.rstudio.com/")
if (!"RSQLite" %in% rownames(installed.packages()))  
      install.packages("RSQLite", repos = "http://cran.rstudio.com/") 
if (!"tidyverse" %in% rownames(installed.packages()))  
      install.packages("tidyverse", repos = "http://cran.rstudio.com/")
if (!"dplyr" %in% rownames(installed.packages()))  
      install.packages("dplyr", repos = "http://cran.rstudio.com/")
suppressMessages(library("DBI"))
suppressMessages(library("RSQLite"))
suppressMessages(library("tidyverse"))
suppressMessages(library("dplyr"))
```

## Q1 LA City Employee Payroll

The `/home/m280-data/la_payroll/LA_City_Employee_Payroll.csv` file on teaching server contains payroll information of LA City employees in years 2013-2017. It was downloaded from [LA City Controller's Office](https://controllerdata.lacity.org/Payroll/City-Employee-Payroll/pazn-qyym). Make a Shiny app to facilitate exploratory data analysis. 

1. For efficiency of the Shiny app, you should first pre-process, pare down, tidy, and save the data, e.g., as a compressed RDS file, to be used in the app.
```{r, results = "hide"}
# import data 
payroll <- read_csv("/home/m280-data/la_payroll/LA_City_Employee_Payroll.csv")

# fix column names (replace space by underscore)
names(payroll) <- str_replace_all(names(payroll), " ", "_")

# change "Other_Pay_(Payroll_Explorer) to otherPay
names(payroll)[24] <- "otherPay"

# select target variables
payroll_small <- payroll %>%
  transmute(year = Year, department = Department_Title,
            job = Job_Class_Title,
            totalPay = abs(as.numeric(substr(Total_Payments, 2, 
                                             length(Total_Payments)))),
            basePay = abs(as.numeric(substr(Base_Pay, 2, length(Base_Pay)))),
            overtimePay = abs(as.numeric(substr(Overtime_Pay, 2, 
                                                length(Overtime_Pay)))),  
            otherPay = abs(as.numeric(substr(otherPay, 2, 
                                             length(otherPay)))),
            totalCost = abs(as.numeric(substr(Average_Benefit_Cost, 2, 
                                              length(Average_Benefit_Cost))))
  )


# convert payroll_small to rds file 
wd <- getwd()
path <- paste0(wd, "/shinyapp/payroll.rds")
saveRDS(payroll_small, path)
```

[link to shinyapp](https://highshuang.shinyapps.io/shinyapp/)

0. **Total payroll by LA City**. Visualize the total LA City payroll of each year, with breakdown into base pay, overtime pay, and other pay.

0. **Who earned most?** Visualize the payroll information (total payment with breakdown into base pay, overtime pay, and other pay, Department, Job Title) of the top $n$ highest paid LA City employees in a specific year. User specifies $n$ (default 10) and year (default 2017).

0. **Which departments earn most?** Visualize the mean or median payroll, with breakdown into base pay, overtime pay, and other pay, of top $n$ earning departments. User specifies $n$ (default 5), year (default 2017), and method (mean or median, default median).

0. **Which departments cost most?** Visualize the total payroll, with breakdown into base pay, overtime pay, and other pay, of top $n$ expensive departments. User specifies $n$ (default 5) and year (default 2017).

0. Visualize any other information you are interested in.

0. Publish your Shiny app to <https://www.shinyapps.io> and share the link.

## Q2 LA City Parking War

The SQLite database `/home/m280-data/la_parking/LA_Parking_Citations.sqlite` on teaching server contains information about parking tickets in LA City. It was downloaded from [LA Open Data Portal](https://data.lacity.org/A-Well-Run-City/Parking-Citations/wjz9-h9np). Connect to the database and answer following questions using plots and summary statistics. In this exercise, you are **not** allowed to load whole data into memory. Use the _transform in database, plot in R_ strategy.

```{r}
# read in data from database
db <- dbConnect(RSQLite::SQLite(), "/home/m280-data/la_parking/LA_Parking_Citations_Extra.sqlite")

# show the data set name in the database db, "latix"
dbListTables(db)

# save latix to R
latix <- dplyr::tbl(db, "latix")

# show all col
head(latix, n = 1, width = Inf) ### delete later 

```

1. How many tickets are in this data set? Which time period do these tickets span? Which years have most data?

```{r}
# total ticket amount: 4044338
latix %>% filter(!is.na(Ticket_number)) %>% 
  count()
```

* In total, there are 4044338 tickets in this data set, after removing the missing values. 
```{r}
# remove missing dates
date <- latix %>% filter(!is.na(Issue_Year), !is.na(Issue_Month), 
                         !is.na(Issue_Day), !is.na(Issue_Wday), 
                         !is.na(Issue_Hour))

date %>% distinct(Issue_Year, Issue_Month, Issue_Day) %>%
  arrange(desc(Issue_Year), desc(Issue_Month), desc(Issue_Day)) %>% collect() %>%
  slice(c(1, n()))
```

* Tickets span from 2010/04/27 to 2017/12/30.

```{r}
date  %>% group_by(Issue_Year) %>%
  summarize(count = n()) %>% arrange(desc(count)) %>% 
  head(n = 1)
```

* Year 2015 has the most data.


0. When (which hour, weekday, month day, and month) are you most likely to get a ticket and when are you least likely to get a ticket?
```{r}
# hour that most/least likey to get a ticket 
date %>% group_by(Issue_Hour) %>%
  summarize(count = n()) %>% arrange(desc(count)) %>% 
  collect() %>%
  slice(c(1, n()))

```

* In the noon (hour = 12), it is most likely to get a ticket. During 5 a.m.(hour = 5), it is leastly likely to get a ticket.


```{r}
# weekday that most/least likey to get a ticket 
date %>% group_by(Issue_Wday) %>%
  summarize(count = n()) %>% arrange(desc(count)) %>% 
  collect() %>%
  slice(c(1, n()))

```

* It is most likely to get a ticket on Wednesday and least likely to get a ticket on Sunday.

```{r}
# month day that most/least likey to get a ticket 
date %>% group_by(Issue_Month, Issue_Day) %>%
  summarize(count = n()) %>% arrange(desc(count)) %>% 
  ungroup() %>% collect() %>%
  slice(c(1, n()))
```

* It is most likely to get a ticket on May 12th and least likely to get a ticket on Nov 28th.

```{r}
# month that most/least likey to get a ticket 
date %>% group_by(Issue_Month) %>%
  summarize(count = n()) %>% arrange(desc(count)) %>% 
  collect() %>%
  slice(c(1, n()))
```

* It is most likely to get a ticket in March and least likely to get a ticket in November.


0. Which car makes received most citations?
```{r}
latix %>% group_by(Make) %>%
  summarize(count = n()) %>%
  arrange(desc(count)) %>% collect() %>%
  head(n = 1)
```

* TOYT makes received most citations (669548 citations).

0. How many different colors of cars were ticketed? Which color attracted most tickets?
```{r}
latix %>% filter(!is.na(Color)) %>%
  distinct(Color) %>%
  count()
```

* There are 65 different colors of cars were ticketed.
```{r}
latix %>% group_by(Color) %>%
  summarize(count = n()) %>%
  arrange(desc(count)) %>% collect() %>%
  head(n = 1)
```

* Color black(BK) attracted most tickets.

0. What are the most common ticket types?
```{r}
latix %>% group_by(Violation_Description) %>%
  summarize(count = n()) %>% 
  arrange(desc(count)) %>% collect() %>%
  head(n = 3)
```

* "NO PARK/STREET CLEAN"," "METER EXP" and "PREFERENTIAL PARKING" are the most common three ticket types.

0. How much money was collected on parking tickets in 2015 and 2016?
```{r}
latix %>% select(Issue_Year, Fine_amount) %>%
  filter(Issue_Year == 2015 | Issue_Year == 2016) %>%
  group_by(Issue_Year) %>%
  summarize(sum = sum(Fine_amount))
```

* 151006794$ was collected on parking ticket in 2015 and 123236136$ was collected on the parking ticket in 2016.

0. Visualize any other information you are interested in.
```{r}
print(latix, width = Inf, n = 1)

latix %>% filter(Issue_Year == 2017, !is.na(Fine_amount), 
                 !is.na(RP_State_Plate)) %>% 
  select(RP_State_Plate, Fine_amount) %>% 
  group_by(RP_State_Plate) %>%
  summarize(sumFine = sum(Fine_amount, na.rm = TRUE)) %>% 
  arrange(desc(sumFine)) %>%
  collect() %>%
  slice(2:11) %>%
  ggplot(aes(x = RP_State_Plate, y = sumFine)) +
  geom_col(fill = "aliceblue", color = "black") +
  labs(
      title = "2017 LA City Parking Ticket Fine from out-of-state vehicles",
      subtitle = "top 10 total fine contributring states",
      y = "Total Fine ($)",
      x = "State"
      )

```

* I am interested in 









